import os
import logging

import youtube_dl
from telethon import events
from telethon.tl.types import Message

#from hikka import (
#    LOADER,
#    LOGGER,
#    tgclient,
#    utils,
#)

# Declare the module's scopes
scopes = ['messages']

# Declare the module's dependencies
dependencies = []

# Initialize the module's logger
logger = LOGGER.module_logger(__name__)

# Declare the module's main class
@LOADER.tds
class YouTubeModule:

    async def client_ready(self, client, db):
        # Initialize the module's client and database objects
        self._client = client
        self._db = db

        # Create a new TelegramClient
        self.client = TelegramClient('session_name', self.api_id, self.api_hash, tgclient=client)

        # Connect to the Telegram servers
        await self.client.start()

    #async def on_unload(self):
        # Disconnect from the Telegram servers
    #    await self.client.disconnect()


    # This function will be called when the userbot receives the "ytd" command
    @LOADER.command(pattern='/ytd (.*)')
    async def download_cmd(self, event):
        # Get the URL of the video from the command
        url = event.pattern_match.group(1)

        # Download the video
        file_name = self.download_video(url)

        # Send the video to the chat
        await self.client.send_file(event.chat_id, file_name, caption='Video downloaded!')

        # Remove the video from the bot's directory
        os.remove(file_name)

    # Download a video from YouTube and return the file name
    @staticmethod
    def download_video(url):
        # Use youtube_dl to download the video
        ydl_opts = {
            'outtmpl': '%(title)s.%(ext)s'
        }
        with youtube_dl.YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])
        return ydl.prepare_filename(ydl.extract_info(url, download=False)).strip()

       
